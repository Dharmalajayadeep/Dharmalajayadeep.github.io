<!DOCTYPE html>
<html>
<head>
  <title>We Fill It Dashboard</title>
  <link rel="stylesheet" href="css/style.css">
</head>
<body>

<div class="sidebar">
  <h2>We Fill It</h2>
  <a href="dashboard.html">Dashboard</a>
  <a href="add-client.html">Add Client</a>
</div>

<div class="main">
  <h1>Owner Dashboard</h1>

  <div class="card">
    <h3>Total Revenue Till Date</h3>
    <h2 id="totalRevenue">₹0</h2>
  </div>

  <div class="card">
    <h3>Active Clients</h3>
    <h2 id="activeClients">0</h2>
  </div>

  <div class="card">
    <canvas id="revenueChart"></canvas>
  </div>

  <div class="card">
    <canvas id="categoryChart"></canvas>
  </div>
</div>


  <div class="card">
    <h3>Active Clients</h3>
    <p id="activeClients">0</p>
  </div>

</div>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
script type="module">

import { auth, db } from './js/firebase-config.js';
import { collection, getDocs } 
from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
import { onAuthStateChanged } 
from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

onAuthStateChanged(auth, async (user) => {

  if (!user) {
    window.location.href = "index.html";
    return;
  }

  const querySnapshot = await getDocs(collection(db, "clients"));

  let totalRevenue = 0;
  let activeClients = 0;

  let categoryCount = {
    visa: 0,
    education: 0,
    placement: 0,
    holiday: 0
  };

  let monthlyRevenue = {};

  querySnapshot.forEach((doc) => {
    const data = doc.data();

    totalRevenue += data.amountReceived || 0;

    if(data.status === "active"){
      activeClients++;
    }

    if(categoryCount[data.category] !== undefined){
      categoryCount[data.category]++;
    }

    if(data.createdAt){
      const date = data.createdAt.toDate();
      const month = date.getMonth() + 1;
      monthlyRevenue[month] = (monthlyRevenue[month] || 0) + (data.amountReceived || 0);
    }

  });

  document.getElementById("totalRevenue").innerText = "₹" + totalRevenue;
  document.getElementById("activeClients").innerText = activeClients;

  createRevenueChart(monthlyRevenue);
  createCategoryChart(categoryCount);

});


function createRevenueChart(monthlyRevenue){

  const labels = [];
  const data = [];

  for(let i=1;i<=12;i++){
    labels.push("Month " + i);
    data.push(monthlyRevenue[i] || 0);
  }

  new Chart(document.getElementById('revenueChart'), {
    type: 'line',
    data: {
      labels: labels,
      datasets: [{
        label: 'Monthly Revenue',
        data: data,
        borderColor: '#22d3ee',
        backgroundColor: 'rgba(34,211,238,0.2)',
        tension: 0.4
      }]
    }
  });
}


function createCategoryChart(categoryCount){

  new Chart(document.getElementById('categoryChart'), {
    type: 'pie',
    data: {
      labels: ['Visa', 'Education', 'Placement', 'Holiday'],
      datasets: [{
        data: [
          categoryCount.visa,
          categoryCount.education,
          categoryCount.placement,
          categoryCount.holiday
        ],
        backgroundColor: [
          '#22d3ee',
          '#f59e0b',
          '#10b981',
          '#ef4444'
        ]
      }]
    }
  });

}

</script>
  
</body>
</html>
